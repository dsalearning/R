---
title: "RBasic Homework"
author: "Alvin Lin"
date: "2017年11月10日"
teacher : "Rafe C.H. Liu"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## **4. 綜合演練**

> 小明想知道信義區的腳踏車站晴天和雨天的使用率有何差別 
  提示：-  
     `filter`、`mutate`、`select`、`group_by`、`summarise` - `dcast` - `arrange`

| sna	| 晴天 | 雨天 |
| :------------ | :------: | :------: |
| 永吉松信路口	| 0.8720583	| 0.4744500 |
| 信義廣場(台北101)	| 0.7952094	| 0.5329188 |
| 捷運永春站(2號出口)	| 0.7888917	| 0.4466667 |
| 市民廣場	| 0.7369417	| 0.3238917 |
| 捷運台北101/世貿站	| 0.7294856	| 0.6448654 |
| 基隆光復路口	| 0.7277750	| 0.7589000 |
| 仁愛逸仙路口	| 0.6532895	| 0.5921053 |
| 三張犁	| 0.6409129	| 0.4242424 |
| 五常公園	| 0.6233278	| 0.3536944 |
| 中強公園	| 0.6216667	| 0.7833333 |

## **<font color="blue">演練開始</font>**
### **Step 1 載入元件**
- `dplyr`
```{r}
#install.packages("dplyr")
#install.packages("magrittr")
#library(magrittr)

library(dplyr)
```

### **Step 2 載入ubike資料**
- Working directory
    - `getwd()`: get working directory
    - `setwd()`
- 讀檔之前，先觀察檔案
    - 編碼通常都是 `UTF8` 或 `BIG5`
    - Linux, Darwin: “UTF-8”
    - Windows: “BIG-5”
- 讀取ubike的數據，使用read.csv
```{r}
ubike <- read.csv(file = "ubike-weather-big5.csv",
          colClasses = c("factor","integer","integer","factor","factor",
                         "numeric","numeric","integer","numeric","integer",
                         "integer","numeric","numeric", "integer","integer",
                         "numeric","numeric","numeric", "numeric","numeric",
                         "numeric", "numeric","numeric"), 
          fileEncoding = 'BIG-5',
          stringsAsFactors = F)

# 以 colClasses 控制每個欄位的 class，這可使讀檔加速
# 以 fileEncoding 定義檔案編碼
```
- 欄位中文英文對照表
```{r}
chin <- c("日期","時間","場站代號","場站區域","場站名稱","經度","緯度",
          "總停車格","平均車輛數","最大車輛數","最小車輛數","車輛數標準差","平均空位數","最大空位數",
          "最小空位數","空位數標準差","氣溫","最高溫","最低溫","溼度","氣壓",
          "最大風速","降雨量")

coln <- data.frame(matrix(data="", ncol=4, nrow=12), stringsAsFactors = FALSE)
coln$X1 <- chin[1:12]
coln$X2 <- colnames(ubike)[1:12]
coln$X3[1:12] <- chin[13:24]
coln$X4[1:12] <- colnames(ubike)[13:24]
# coln
```
| 欄位名稱	   | 代號     | 欄位名稱     | 代號      |
| :----------- | :------- | :----------- | :-------- |   
| 日期         | date     | 平均空位數   | avg.bemp  | 
| 時間         | hour     | 最大空位數   | max.bemp  |
| 場站代號     | sno      | 最小空位數   | min.bemp  |
| 場站區域     | sarea    | 空位數標準差 | std.bemp  |
| 場站名稱     | sna      | 氣溫         | temp      |
| 經度         | lat      | 最高溫       | max.temp  |
| 緯度         | lng      | 最低溫       | min.temp  |
| 總停車格     | tot      | 溼度         | humidity  |
| 平均車輛數   | avg.sbi  | 氣壓         | pressure  |
| 最大車輛數   | max.sbi  | 最大風速     | max.anemo |
| 最小車輛數   | min.sbi  | 降雨量       | rainfall  |
| 車輛數標準差 | std.sbi  |              |           |

### **Step 3 檢查Data**
```{r}
# 檢查前10筆數據
head(ubike, 10)
```
- 檢查最末10筆數據
```{r}
tail(ubike, 10)
```

_<font color="red">此時發現有「NA」值</font>_

- 檢查Table結構
```{r}
str(ubike)
```

_<font color="red">發現date是Factor! 而非日期</font>_

- 將ubike$date轉型成Date
```{r}
ubike$date <- as.Date(ubike$date)
str(ubike)
```
- 好奇看一下Factor類型的值
```{r}
levels(ubike$sarea)
levels(ubike$sna)
# 也可以用下列語法查看
# unique(ubike$sarea)
# unique(ubike$sna)
```
- 查看資料的分佈情況
```{r}
summary(ubike)
```

_<font color="red">可以清楚看到下列欄位有「NA」值與筆數各為多少</font>_

| sna	    | std.sbi  | std.bemp | temp     | max.temp | min.temp | humidity | pressure | max.anemo | rainfall |
| :-----: | :------: | :------: | :------: | :------: | :------: | :------: | :------: | :------:  | :------: |
| 48      | 3	       | 3        | 4278     | 4278     |  4278    | 4278     | 4278     | 4278      | 4278     |

### **Step 4 查詢出需要的Data**
- 可以用`is.na()`或 `!= 'NA'`來濄篩有NA的。
- 用`mutate`新增欄位`weather.type`，用`ifelse`判斷rainfall>0為`雨天`，其它則為`晴天`
- 定義 : 使用率 = 平均空位數 / 總停車格
- 用`summarise`與`group_by`來做彙總，新增出欄位`usage.ratio`
```{r}
ubike1 <- select(ubike, sarea, sna, tot, avg.bemp, rainfall) %>%
            filter(sarea == '信義區' & is.na(rainfall)==FALSE) %>%
            mutate(weather.type = ifelse(rainfall>0,'雨天','晴天')) %>%
            group_by(sna, weather.type) %>%          
            summarise(usage.ratio = mean((avg.bemp)/tot))
#檢視本次結果集
head(ubike1)
```

- 載入`reshape2`
- 用reshape2的`dcast`將weather.type轉置
- 查出結果並用`arrange`對`晴天`做遞增排序
```{r}
#install.packages("reshape2")
library(reshape2)
```
```{r}
ubike2 <- dcast(ubike1, sna ~ weather.type, value.var="usage.ratio")
# 查出本次作業的要求結果
select(ubike2, sna, 晴天, 雨天) %>% arrange(晴天 %>% desc())
```

## **<font color="blue">練習畫圖</font>**
### **使用ggplot2繪圖**
```{r}
#install.packages("ggplot2")
library(ggplot2)
```
- 晴雨天比較圖
```{r}
## position = "dodge"
ggplot(ubike1, aes(x=sna, y=usage.ratio, fill = weather.type)) + 
  geom_bar(position = "dodge", stat = "identity")
```

### **使用plotly繪圖**
```{r}
#install.packages("plotly")
library(plotly)
```
```{r}
dia <- ggplot(ubike1, aes(x=sna, y=usage.ratio, fill = weather.type)) + 
  geom_bar(position = "dodge", stat = "identity")

ggplotly(dia)
```

### **練習ggmap畫圖**
```{r}
library(ggmap)
gmap <- ggmap(
  get_googlemap(
    center = c(lon=121.55, lat=25.05),
    zoom = 12,
#    size = c(640, 640),
#    scale = 2,
    maptype = c("terrain", "satellite","roadmap","hybrid")
  ) #,extent = "panel" , darken = 0
)  
gmap1 <- gmap + 
  geom_point(
    data = ubike, 
    aes(x = lng, y = lat), 
    color = "blue",
    size = 1
  )
gmap1
```





